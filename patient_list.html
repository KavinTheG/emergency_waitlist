<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patients List</title>
    <link rel="stylesheet" href="style.css">
    <script>

        const severityScore = {
            'High': 3,
            'Medium': 2,
            'Low': 1
        };

        let highestPriority = null;

        document.addEventListener('DOMContentLoaded', () => {
            fetchPatients();
        });

        function fetchPatients() {
            fetch('http://localhost:8001/api.php?action=getPatients')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.getElementById('patients-table-body');
                    tableBody.innerHTML = '';
                    console.log(patientToTreat(data.patients));
                    highestPriority = data.patients[0];
                    data.patients.forEach(patient => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${patient.name}</td>
                            <td>${patient.severity_of_injury}</td>
                            <td>${patient.approx_wait_time}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    document.getElementById('treat').textContent= `Treat ${highestPriority.name}`;
                })
                .catch(error => {
                    console.error('Error fetching patients:', error);
                });
        }

        function patientToTreat(patients) {
            // Sort patients by severity and wait time
            patients.sort((a, b) => {
                // Compare severity scores first
                if (severityScore[a.severity_of_injury] !== severityScore[b.severity_of_injury]) {
                    return severityScore[b.severity_of_injury] - severityScore[a.severity_of_injury];
                }
                // If severity is the same, compare wait times
                return a.approx_wait_time - b.approx_wait_time;
            });

            // Return the patient with the highest priority
            return patients.length > 0 ? patients[0] : null;
        }


        function treatPatient(event) {
            event.preventDefault();
            console.log("treatPatient called")
            
            if (highestPriority != null) {
                fetch('http://localhost:8001/api.php?action=treatPatient', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: `name=${highestPriority.name}&userid=${highestPriority.userid}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.valid) {
                        console.log("user removed");
                    } else {
                        alert("Invalid.");
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
                fetchPatients();
            }

            
        }

    </script>
</head>
<body>
    <div class="container">
        <h1>Patients List</h1>
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Severity of Injury</th>
                    <th>Approximate Wait Time</th>
                </tr>
            </thead>
            <tbody id="patients-table-body">
=            </tbody>
        </table>

        <button onclick="treatPatient(event)" id="treat"></button>
    </div>
</body>
</html>
